select split_part(timestamp, ' ', 1),
       case
         when substr(t1.phone, 1, 4) in ('1708', '1704', '1709', '1707') then
          '联通'
         when substr(t1.phone, 1, 4) in ('1703', '1705', '1706') then
          '移动'
         when substr(t1.phone, 1, 4) in ('1701', '1702', '1349') then
          '电信'
         when substr(t1.phone, 1, 3) in ('133',
                                         '153',
                                         '162',
                                         '168',
                                         '169',
                                         '173',
                                         '174',
                                         '177',
                                         '179',
                                         '180',
                                         '181',
                                         '189',
                                         '189',
                                         '191',
                                         '196',
                                         '197',
                                         '199') then
          '电信'
         when substr(t1.phone, 1, 3) in ('130',
                                         '131',
                                         '132',
                                         '140',
                                         '146',
                                         '155',
                                         '156',
                                         '163',
                                         '166',
                                         '167',
                                         '171',
                                         '175',
                                         '176',
                                         '185',
                                         '186',
                                         '192',
                                         '193') then
          '联通'
         when substr(t1.phone, 1, 3) in ('134',
                                         '135',
                                         '136',
                                         '137',
                                         '138',
                                         '139',
                                         '144',
                                         '147',
                                         '148',
                                         '150',
                                         '151',
                                         '152',
                                         '157',
                                         '158',
                                         '159',
                                         '165',
                                         '172',
                                         '178',
                                         '182',
                                         '183',
                                         '184',
                                         '187',
                                         '188',
                                         '195',
                                         '198') then
          '移动'
       end
       
      , 
       count(1)
  from dw.fact_threevaild_detail t1
  where split_part(timestamp, ' ', 1)>='2021-12-01'
  and split_part(timestamp, ' ', 1)<='2021-12-31'
 and t1.respcode in
       ('P300', 'P301', 'P305', 'P306', 'P307', 'SJ', 'NM', 'ID')
 group by split_part(timestamp, ' ', 1),
       case
         when substr(t1.phone, 1, 4) in ('1708', '1704', '1709', '1707') then
          '联通'
         when substr(t1.phone, 1, 4) in ('1703', '1705', '1706') then
          '移动'
         when substr(t1.phone, 1, 4) in ('1701', '1702', '1349') then
          '电信'
         when substr(t1.phone, 1, 3) in ('133',
                                         '153',
                                         '162',
                                         '168',
                                         '169',
                                         '173',
                                         '174',
                                         '177',
                                         '179',
                                         '180',
                                         '181',
                                         '189',
                                         '189',
                                         '191',
                                         '196',
                                         '197',
                                         '199') then
          '电信'
         when substr(t1.phone, 1, 3) in ('130',
                                         '131',
                                         '132',
                                         '140',
                                         '146',
                                         '155',
                                         '156',
                                         '163',
                                         '166',
                                         '167',
                                         '171',
                                         '175',
                                         '176',
                                         '185',
                                         '186',
                                         '192',
                                         '193') then
          '联通'
         when substr(t1.phone, 1, 3) in ('134',
                                         '135',
                                         '136',
                                         '137',
                                         '138',
                                         '139',
                                         '144',
                                         '147',
                                         '148',
                                         '150',
                                         '151',
                                         '152',
                                         '157',
                                         '158',
                                         '159',
                                         '165',
                                         '172',
                                         '178',
                                         '182',
                                         '183',
                                         '184',
                                         '187',
                                         '188',
                                         '195',
                                         '198') then
          '移动'
       end;
